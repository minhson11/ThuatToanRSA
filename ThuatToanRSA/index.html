<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truy·ªÅn File v·ªõi Ch·ªØ K√Ω S·ªë RSA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 2px,
                rgba(255,255,255,0.1) 2px,
                rgba(255,255,255,0.1) 4px
            );
            animation: shimmer 20s linear infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%); }
            100% { transform: translateX(100%) translateY(100%); }
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            color: #6c757d;
        }

        .tab.active {
            background: white;
            color: #007bff;
            transform: translateY(-3px);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(45deg, #007bff, #00d4ff);
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .content {
            padding: 40px;
            min-height: 400px;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1rem;
        }

        input[type="file"], input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        input[type="file"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #007bff;
            background: white;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .btn {
            background: linear-gradient(45deg, #007bff, #00d4ff);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,123,255,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .info-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

        .info-box::before {
            content: 'üîê';
            position: absolute;
            top: -10px;
            left: 20px;
            background: white;
            padding: 0 10px;
            font-size: 1.5rem;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .status.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .keys-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
            word-break: break-all;
        }

        .download-link {
            display: inline-block;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            text-decoration: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .download-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(40,167,69,0.3);
            text-decoration: none;
            color: white;
        }

        .file-info {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .signature-box {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            color: #6c757d;
        }

        .receive-method {
            animation: fadeIn 0.5s ease-in;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-bottom: 1px solid #dee2e6;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Truy·ªÅn File v·ªõi Ch·ªØ K√Ω S·ªë</h1>
            <p>B·∫£o m·∫≠t file v·ªõi c√¥ng ngh·ªá RSA</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showSection('signer')">Ng∆∞·ªùi K√Ω</button>
            <button class="tab" onclick="showSection('transfer')">G·ª≠i File</button>
            <button class="tab" onclick="showSection('receiver')">Ng∆∞·ªùi Nh·∫≠n</button>
        </div>
        
        <div class="content">
            <!-- Ph·∫ßn ng∆∞·ªùi k√Ω -->
            <div id="signer" class="section active">
                <h2>üì§ K√Ω v√† G·ª≠i File</h2>
                
                <div class="form-group">
                    <label for="fileInput">Ch·ªçn file c·∫ßn k√Ω:</label>
                    <input type="file" id="fileInput" accept="*" onchange="handleFileSelect(event)">
                </div>
                
                <div class="file-info" id="fileInfo"></div>
                
                <div class="form-group">
                    <button class="btn" onclick="generateKeys()" id="generateBtn">T·∫°o C·∫∑p Kh√≥a RSA</button>
                </div>
                
                <div id="keysDisplay" style="display: none;">
                    <h3>üîë Kh√≥a C√¥ng Khai (G·ª≠i cho ng∆∞·ªùi nh·∫≠n):</h3>
                    <div class="keys-display" id="publicKeyDisplay"></div>
                    
                    <h3>üîí Kh√≥a Ri√™ng T∆∞ (Gi·ªØ b√≠ m·∫≠t):</h3>
                    <div class="keys-display" id="privateKeyDisplay"></div>
                </div>
                
                <div class="form-group">
                    <button class="btn" onclick="signFile()" id="signBtn" disabled>K√Ω File</button>
                </div>
                
                <div class="signature-box" id="signatureDisplay">
                    Ch·ªØ k√Ω s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y sau khi k√Ω file
                </div>
                
                <div class="status" id="signerStatus"></div>
            </div>
            
            <!-- Ph·∫ßn g·ª≠i file -->
            <div id="transfer" class="section">
                <h2>üì§ G·ª≠i File ƒê√£ K√Ω</h2>
                
                <div class="info-box">
                    <h3>üìã Th√¥ng tin g·ª≠i file:</h3>
                    <p>Sau khi k√Ω file, b·∫°n c√≥ th·ªÉ t·∫°o m·ªôt g√≥i truy·ªÅn ƒë·ªÉ g·ª≠i cho ng∆∞·ªùi nh·∫≠n. G√≥i n√†y s·∫Ω bao g·ªìm:</p>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>File g·ªëc ƒë√£ k√Ω</li>
                        <li>Kh√≥a c√¥ng khai ƒë·ªÉ x√°c minh</li>
                        <li>Ch·ªØ k√Ω s·ªë</li>
                        <li>Th√¥ng tin file</li>
                    </ul>
                </div>
                
                <div id="transferContent" style="display: none;">
                    <div class="form-group">
                        <label for="recipientName">T√™n ng∆∞·ªùi nh·∫≠n:</label>
                        <input type="text" id="recipientName" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n...">
                    </div>
                    
                    <div class="form-group">
                        <label for="transferNote">Ghi ch√∫ (t√πy ch·ªçn):</label>
                        <input type="text" id="transferNote" placeholder="Ghi ch√∫ cho ng∆∞·ªùi nh·∫≠n...">
                    </div>
                    
                    <div class="form-group">
                        <button class="btn" onclick="createTransferPackage()">üì¶ T·∫°o G√≥i Truy·ªÅn</button>
                    </div>
                    
                    <div id="transferPackage" style="display: none;">
                        <h3>üì¶ G√≥i Truy·ªÅn ƒê√£ T·∫°o</h3>
                        <div class="info-box">
                            <p><strong>T√™n g√≥i:</strong> <span id="packageName"></span></p>
                            <p><strong>Ng∆∞·ªùi nh·∫≠n:</strong> <span id="packageRecipient"></span></p>
                            <p><strong>Th·ªùi gian t·∫°o:</strong> <span id="packageTime"></span></p>
                            <p><strong>K√≠ch th∆∞·ªõc:</strong> <span id="packageSize"></span></p>
                        </div>
                        
                        <div class="form-group">
                            <a href="#" class="download-link" id="downloadPackage" download>
                                üì• T·∫£i G√≥i Truy·ªÅn Xu·ªëng
                            </a>
                        </div>
                        
                        <div class="info-box" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                            <h4>üìã H∆∞·ªõng d·∫´n g·ª≠i file:</h4>
                            <ol style="margin-left: 20px; margin-top: 10px;">
                                <li>T·∫£i g√≥i truy·ªÅn xu·ªëng m√°y</li>
                                <li>G·ª≠i file n√†y cho ng∆∞·ªùi nh·∫≠n qua email, chat, ho·∫∑c USB</li>
                                <li>H∆∞·ªõng d·∫´n ng∆∞·ªùi nh·∫≠n s·ª≠ d·ª•ng tab "Nh·∫≠n File" ƒë·ªÉ x√°c minh</li>
                            </ol>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn" onclick="generateQRCode()" style="background: linear-gradient(45deg, #9c27b0, #e91e63);">
                                üì± T·∫°o M√£ QR
                            </button>
                        </div>
                        
                        <div id="qrCodeSection" style="display: none; text-align: center; margin: 20px 0;">
                            <h4>üì± M√£ QR cho G√≥i Truy·ªÅn</h4>
                            <div id="qrCode" style="margin: 20px 0;"></div>
                            <p style="font-size: 0.9rem; color: #666;">
                                Ng∆∞·ªùi nh·∫≠n c√≥ th·ªÉ qu√©t m√£ QR n√†y ƒë·ªÉ nh·∫≠n th√¥ng tin g√≥i truy·ªÅn
                            </p>
                        </div>
                    </div>
                </div>
                
                <div id="noSignedFile" class="info-box" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);">
                    <h3>‚ö†Ô∏è Ch∆∞a c√≥ file ƒë√£ k√Ω</h3>
                    <p>Vui l√≤ng quay l·∫°i tab "Ng∆∞·ªùi K√Ω" ƒë·ªÉ:</p>
                    <ol style="margin-left: 20px; margin-top: 10px;">
                        <li>Ch·ªçn file c·∫ßn k√Ω</li>
                        <li>T·∫°o c·∫∑p kh√≥a RSA</li>
                        <li>K√Ω file</li>
                    </ol>
                    <button class="btn" onclick="showSection('signer'); document.querySelector('.tab').click();" style="margin-top: 15px;">
                        üîô Quay l·∫°i K√Ω File
                    </button>
                </div>
                
                <div class="status" id="transferStatus"></div>
            </div>
            
            <!-- Ph·∫ßn ng∆∞·ªùi nh·∫≠n -->
            <div id="receiver" class="section">
                <h2>üì• Nh·∫≠n v√† X√°c Minh File</h2>
                
                <div class="tabs" style="background: #f1f3f4; margin-bottom: 20px; border-radius: 10px;">
                    <button class="tab" onclick="showReceiveMethod('manual')" id="manualTab" style="border-radius: 10px 0 0 10px;">
                        ‚úã Nh·∫≠p Th·ªß C√¥ng
                    </button>
                    <button class="tab active" onclick="showReceiveMethod('package')" id="packageTab" style="border-radius: 0 10px 10px 0;">
                        üì¶ T·ª´ G√≥i Truy·ªÅn
                    </button>
                </div>
                
                <!-- Ph∆∞∆°ng th·ª©c nh·∫≠n t·ª´ g√≥i truy·ªÅn -->
                <div id="receivePackage" class="receive-method active">
                    <div class="form-group">
                        <label for="packageFileInput">Ch·ªçn g√≥i truy·ªÅn ƒë√£ nh·∫≠n:</label>
                        <input type="file" id="packageFileInput" accept=".json" onchange="handlePackageFile(event)">
                    </div>
                    
                    <div id="packageInfo" style="display: none;">
                        <div class="info-box">
                            <h3>üì¶ Th√¥ng tin g√≥i truy·ªÅn:</h3>
                            <div id="packageDetails"></div>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn" onclick="verifyPackage()">üîç X√°c Minh G√≥i Truy·ªÅn</button>
                        </div>
                    </div>
                </div>
                
                <!-- Ph∆∞∆°ng th·ª©c nh·∫≠p th·ªß c√¥ng -->
                <div id="receiveManual" class="receive-method" style="display: none;">
                    <div class="form-group">
                        <label for="receivedFileInput">File nh·∫≠n ƒë∆∞·ª£c:</label>
                        <input type="file" id="receivedFileInput" accept="*" onchange="handleReceivedFile(event)">
                    </div>

                    <div class="form-group">
                        <label for="publicKeyInput">Kh√≥a c√¥ng khai c·ªßa ng∆∞·ªùi g·ª≠i:</label>
                        <input type="text" id="publicKeyInput" placeholder="D√°n kh√≥a c√¥ng khai v√†o ƒë√¢y...">
                    </div>

                    <div class="form-group">
                        <label for="signatureInput">Ch·ªØ k√Ω t·ª´ ng∆∞·ªùi g·ª≠i:</label>
                        <input type="text" id="signatureInput" placeholder="D√°n ch·ªØ k√Ω v√†o ƒë√¢y...">
                    </div>

                    <div class="form-group">
                        <button class="btn" onclick="verifySignature()" id="verifyBtn">üîç X√°c Minh Ch·ªØ K√Ω</button>
                    </div>
                </div>
                
                <div class="info-box" id="verificationResult" style="display: none;">
                    <h3>K·∫øt qu·∫£ x√°c minh:</h3>
                    <div id="verificationStatus"></div>
                    <div id="downloadSection" style="display: none;">
                        <p>‚úÖ File ƒë√£ ƒë∆∞·ª£c x√°c minh th√†nh c√¥ng!</p>
                        <a href="#" class="download-link" id="downloadLink" download>üì• T·∫£i File Xu·ªëng</a>
                    </div>
                </div>
                
                <div class="status" id="receiverStatus"></div>
            </div>
        </div>
    </div>

    <script>
        // Bi·∫øn to√†n c·ª•c
        let currentFile = null;
        let keyPair = null;
        let fileSignature = null;
        let receivedFile = null;
        let transferPackageData = null;

        // H√†m chuy·ªÉn ƒë·ªïi tab
        function showSection(section) {
            // ·∫®n t·∫•t c·∫£ sections
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tabs > .tab').forEach(t => t.classList.remove('active'));
            
            // Hi·ªÉn th·ªã section ƒë∆∞·ª£c ch·ªçn
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
            
            // Ki·ªÉm tra v√† hi·ªÉn th·ªã n·ªôi dung ph√π h·ª£p cho tab g·ª≠i file
            if (section === 'transfer') {
                checkSignedFileStatus();
            }
            
            // Reset tr·∫°ng th√°i cho tab ng∆∞·ªùi nh·∫≠n
            if (section === 'receiver') {
                showReceiveMethod('package');
            }
        }

        // H√†m chuy·ªÉn ƒë·ªïi ph∆∞∆°ng th·ª©c nh·∫≠n file
        function showReceiveMethod(method) {
            // ·∫®n t·∫•t c·∫£ ph∆∞∆°ng th·ª©c
            document.querySelectorAll('.receive-method').forEach(m => {
                m.style.display = 'none';
                m.classList.remove('active');
            });
            
            // B·ªè active cho t·∫•t c·∫£ tab con
            document.querySelectorAll('#receiver .tab').forEach(t => t.classList.remove('active'));
            
            // Hi·ªÉn th·ªã ph∆∞∆°ng th·ª©c ƒë∆∞·ª£c ch·ªçn
            if (method === 'manual') {
                document.getElementById('receiveManual').style.display = 'block';
                document.getElementById('receiveManual').classList.add('active');
                document.getElementById('manualTab').classList.add('active');
            } else {
                document.getElementById('receivePackage').style.display = 'block';
                document.getElementById('receivePackage').classList.add('active');
                document.getElementById('packageTab').classList.add('active');
            }
        }

        // H√†m hi·ªÉn th·ªã th√¥ng b√°o tr·∫°ng th√°i
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // X·ª≠ l√Ω ch·ªçn file ·ªü ph·∫ßn ng∆∞·ªùi k√Ω
        function handleFileSelect(event) {
            currentFile = event.target.files[0];
            if (currentFile) {
                const fileInfo = document.getElementById('fileInfo');
                fileInfo.innerHTML = `
                    <strong>üìÑ File ƒë√£ ch·ªçn:</strong><br>
                    T√™n: ${currentFile.name}<br>
                    K√≠ch th∆∞·ªõc: ${(currentFile.size / 1024).toFixed(2)} KB<br>
                    Lo·∫°i: ${currentFile.type || 'Kh√¥ng x√°c ƒë·ªãnh'}
                `;
                fileInfo.style.display = 'block';
                
                // Enable sign button if keys exist
                if (keyPair) {
                    document.getElementById('signBtn').disabled = false;
                }
            }
        }

        // X·ª≠ l√Ω file nh·∫≠n ƒë∆∞·ª£c ·ªü ph·∫ßn ng∆∞·ªùi nh·∫≠n
        function handleReceivedFile(event) {
            receivedFile = event.target.files[0];
        }

        // H√†m chuy·ªÉn ƒë·ªïi ArrayBuffer sang Base64
        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // H√†m chuy·ªÉn ƒë·ªïi Base64 sang ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const buffer = new ArrayBuffer(binary.length);
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return buffer;
        }

        // T·∫°o c·∫∑p kh√≥a RSA
        async function generateKeys() {
            try {
                showStatus('signerStatus', 'ƒêang t·∫°o c·∫∑p kh√≥a RSA...', 'success');
                
                keyPair = await window.crypto.subtle.generateKey(
                    {
                        name: "RSA-PSS",
                        modulusLength: 2048,
                        publicExponent: new Uint8Array([1, 0, 1]),
                        hash: "SHA-256",
                    },
                    true,
                    ["sign", "verify"]
                );

                // Xu·∫•t kh√≥a c√¥ng khai
                const publicKey = await window.crypto.subtle.exportKey("spki", keyPair.publicKey);
                const publicKeyBase64 = arrayBufferToBase64(publicKey);
                
                // Xu·∫•t kh√≥a ri√™ng t∆∞
                const privateKey = await window.crypto.subtle.exportKey("pkcs8", keyPair.privateKey);
                const privateKeyBase64 = arrayBufferToBase64(privateKey);

                // Hi·ªÉn th·ªã kh√≥a
                document.getElementById('publicKeyDisplay').textContent = publicKeyBase64;
                document.getElementById('privateKeyDisplay').textContent = privateKeyBase64;
                document.getElementById('keysDisplay').style.display = 'block';

                // Enable sign button if file is selected
                if (currentFile) {
                    document.getElementById('signBtn').disabled = false;
                }

                showStatus('signerStatus', '‚úÖ ƒê√£ t·∫°o c·∫∑p kh√≥a RSA th√†nh c√¥ng!', 'success');
            } catch (error) {
                showStatus('signerStatus', '‚ùå L·ªói khi t·∫°o kh√≥a: ' + error.message, 'error');
            }
        }

        // K√Ω file
        async function signFile() {
            if (!currentFile || !keyPair) {
                showStatus('signerStatus', '‚ùå Vui l√≤ng ch·ªçn file v√† t·∫°o kh√≥a tr∆∞·ªõc!', 'error');
                return;
            }

            try {
                showStatus('signerStatus', 'ƒêang k√Ω file...', 'success');

                // ƒê·ªçc file
                const fileBuffer = await currentFile.arrayBuffer();
                
                // T·∫°o hash c·ªßa file
                const hashBuffer = await window.crypto.subtle.digest('SHA-256', fileBuffer);
                
                // K√Ω hash
                const signature = await window.crypto.subtle.sign(
                    {
                        name: "RSA-PSS",
                        saltLength: 32,
                    },
                    keyPair.privateKey,
                    hashBuffer
                );

                fileSignature = arrayBufferToBase64(signature);
                
                // Hi·ªÉn th·ªã ch·ªØ k√Ω
                document.getElementById('signatureDisplay').innerHTML = `
                    <strong>‚úÖ Ch·ªØ k√Ω ƒë√£ t·∫°o:</strong><br>
                    <small style="word-break: break-all; color: #007bff;">${fileSignature}</small>
                `;

                showStatus('signerStatus', '‚úÖ ƒê√£ k√Ω file th√†nh c√¥ng! H√£y chuy·ªÉn sang tab "G·ª≠i File" ƒë·ªÉ t·∫°o g√≥i truy·ªÅn.', 'success');
            } catch (error) {
                showStatus('signerStatus', '‚ùå L·ªói khi k√Ω file: ' + error.message, 'error');
            }
        }

        // Ki·ªÉm tra tr·∫°ng th√°i file ƒë√£ k√Ω
        function checkSignedFileStatus() {
            const transferContent = document.getElementById('transferContent');
            const noSignedFile = document.getElementById('noSignedFile');
            
            if (currentFile && keyPair && fileSignature) {
                transferContent.style.display = 'block';
                noSignedFile.style.display = 'none';
            } else {
                transferContent.style.display = 'none';
                noSignedFile.style.display = 'block';
            }
        }

        // T·∫°o g√≥i truy·ªÅn
        async function createTransferPackage() {
            const recipientName = document.getElementById('recipientName').value.trim();
            
            if (!recipientName) {
                showStatus('transferStatus', '‚ùå Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n!', 'error');
                return;
            }

            try {
                showStatus('transferStatus', 'ƒêang t·∫°o g√≥i truy·ªÅn...', 'success');

                // ƒê·ªçc file g·ªëc
                const fileBuffer = await currentFile.arrayBuffer();
                const fileBase64 = arrayBufferToBase64(fileBuffer);
                
                // Xu·∫•t kh√≥a c√¥ng khai
                const publicKey = await window.crypto.subtle.exportKey("spki", keyPair.publicKey);
                const publicKeyBase64 = arrayBufferToBase64(publicKey);

                // T·∫°o g√≥i truy·ªÅn
                transferPackageData = {
                    version: "1.0",
                    timestamp: new Date().toISOString(),
                    sender: "Ng∆∞·ªùi k√Ω",
                    recipient: recipientName,
                    note: document.getElementById('transferNote').value.trim(),
                    file: {
                        name: currentFile.name,
                        type: currentFile.type,
                        size: currentFile.size,
                        data: fileBase64
                    },
                    publicKey: publicKeyBase64,
                    signature: fileSignature,
                    hash: "SHA-256"
                };

                // T·∫°o file JSON
                const packageJson = JSON.stringify(transferPackageData, null, 2);
                const packageBlob = new Blob([packageJson], { type: 'application/json' });
                const packageUrl = URL.createObjectURL(packageBlob);

                // C·∫≠p nh·∫≠t th√¥ng tin g√≥i
                const packageName = `${currentFile.name.split('.')[0]}_signed_package.json`;
                document.getElementById('packageName').textContent = packageName;
                document.getElementById('packageRecipient').textContent = recipientName;
                document.getElementById('packageTime').textContent = new Date().toLocaleString('vi-VN');
                document.getElementById('packageSize').textContent = (packageBlob.size / 1024).toFixed(2) + ' KB';

                // T·∫°o link download
                const downloadLink = document.getElementById('downloadPackage');
                downloadLink.href = packageUrl;
                downloadLink.download = packageName;

                // Hi·ªÉn th·ªã g√≥i truy·ªÅn
                document.getElementById('transferPackage').style.display = 'block';
                
                showStatus('transferStatus', '‚úÖ ƒê√£ t·∫°o g√≥i truy·ªÅn th√†nh c√¥ng!', 'success');
            } catch (error) {
                showStatus('transferStatus', '‚ùå L·ªói khi t·∫°o g√≥i truy·ªÅn: ' + error.message, 'error');
            }
        }

        // T·∫°o m√£ QR
        function generateQRCode() {
            if (!transferPackageData) return;

            const qrData = {
                type: "RSA_SIGNED_PACKAGE",
                packageName: document.getElementById('packageName').textContent,
                recipient: transferPackageData.recipient,
                fileInfo: {
                    name: transferPackageData.file.name,
                    size: transferPackageData.file.size
                },
                timestamp: transferPackageData.timestamp
            };

            // T·∫°o QR code ƒë∆°n gi·∫£n (text-based)
            const qrContent = JSON.stringify(qrData, null, 2);
            const qrSection = document.getElementById('qrCodeSection');
            const qrCodeDiv = document.getElementById('qrCode');
            
            qrCodeDiv.innerHTML = `
                <div style="background: white; border: 2px solid #333; padding: 20px; display: inline-block; font-family: monospace; font-size: 8px; line-height: 1;">
                    <div style="text-align: center; margin-bottom: 10px; font-size: 12px; font-weight: bold;">QR Code Info</div>
                    <div style="word-break: break-all; max-width: 200px;">${qrContent}</div>
                </div>
            `;
            
            qrSection.style.display = 'block';
            showStatus('transferStatus', '‚úÖ ƒê√£ t·∫°o m√£ QR th√¥ng tin g√≥i truy·ªÅn!', 'success');
        }

        // X·ª≠ l√Ω file g√≥i truy·ªÅn
        function handlePackageFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const packageData = JSON.parse(e.target.result);
                    
                    // Hi·ªÉn th·ªã th√¥ng tin g√≥i
                    document.getElementById('packageDetails').innerHTML = `
                        <p><strong>üì¶ T√™n g√≥i:</strong> ${file.name}</p>
                        <p><strong>üë§ Ng∆∞·ªùi g·ª≠i:</strong> ${packageData.sender || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                        <p><strong>üë• Ng∆∞·ªùi nh·∫≠n:</strong> ${packageData.recipient || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                        <p><strong>üìÑ File g·ªëc:</strong> ${packageData.file.name}</p>
                        <p><strong>üìè K√≠ch th∆∞·ªõc:</strong> ${(packageData.file.size / 1024).toFixed(2)} KB</p>
                        <p><strong>üïí Th·ªùi gian:</strong> ${new Date(packageData.timestamp).toLocaleString('vi-VN')}</p>
                        <p><strong>üí¨ Ghi ch√∫:</strong> ${packageData.note || 'Kh√¥ng c√≥'}</p>
                    `;
                    
                    document.getElementById('packageInfo').style.display = 'block';
                    
                    // L∆∞u d·ªØ li·ªáu g√≥i ƒë·ªÉ x·ª≠ l√Ω
                    window.currentPackageData = packageData;
                    
                } catch (error) {
                    showStatus('receiverStatus', '‚ùå File g√≥i truy·ªÅn kh√¥ng h·ª£p l·ªá!', 'error');
                }
            };
            reader.readAsText(file);
        }

        // X√°c minh g√≥i truy·ªÅn
        async function verifyPackage() {
            if (!window.currentPackageData) {
                showStatus('receiverStatus', '‚ùå Vui l√≤ng ch·ªçn file g√≥i truy·ªÅn!', 'error');
                return;
            }

            try {
                showStatus('receiverStatus', 'ƒêang x√°c minh g√≥i truy·ªÅn...', 'success');

                const packageData = window.currentPackageData;
                
                // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu file t·ª´ base64
                const fileBuffer = base64ToArrayBuffer(packageData.file.data);
                
                // Import kh√≥a c√¥ng khai
                const publicKeyBuffer = base64ToArrayBuffer(packageData.publicKey);
                const publicKey = await window.crypto.subtle.importKey(
                    "spki",
                    publicKeyBuffer,
                    {
                        name: "RSA-PSS",
                        hash: "SHA-256",
                    },
                    false,
                    ["verify"]
                );

                // T·∫°o hash c·ªßa file
                const hashBuffer = await window.crypto.subtle.digest('SHA-256', fileBuffer);
                
                // Chuy·ªÉn ƒë·ªïi ch·ªØ k√Ω t·ª´ base64
                const signatureBuffer = base64ToArrayBuffer(packageData.signature);

                // X√°c minh ch·ªØ k√Ω
                const isValid = await window.crypto.subtle.verify(
                    {
                        name: "RSA-PSS",
                        saltLength: 32,
                    },
                    publicKey,
                    signatureBuffer,
                    hashBuffer
                );

                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                const resultDiv = document.getElementById('verificationResult');
                const statusDiv = document.getElementById('verificationStatus');
                const downloadSection = document.getElementById('downloadSection');

                resultDiv.style.display = 'block';

                if (isValid) {
                    statusDiv.innerHTML = `
                        <div style="color: #155724; font-weight: bold; font-size: 1.2rem;">
                            ‚úÖ G√ìI TRUY·ªÄN H·ª¢P L·ªÜ
                        </div>
                        <p style="margin-top: 10px;">G√≥i truy·ªÅn ƒë√£ ƒë∆∞·ª£c x√°c minh th√†nh c√¥ng. File nguy√™n b·∫£n kh√¥ng b·ªã thay ƒë·ªïi.</p>
                        <div style="margin-top: 15px; padding: 10px; background: #d1f2eb; border-radius: 5px;">
                            <strong>üìã Th√¥ng tin x√°c minh:</strong><br>
                            ‚Ä¢ Ch·ªØ k√Ω h·ª£p l·ªá ‚úÖ<br>
                            ‚Ä¢ File nguy√™n v·∫πn ‚úÖ<br>
                            ‚Ä¢ Kh√≥a c√¥ng khai ƒë√∫ng ‚úÖ
                        </div>
                    `;
                    
                    // T·∫°o file blob v√† link download
                    const fileBlob = new Blob([fileBuffer], { type: packageData.file.type });
                    const downloadLink = document.getElementById('downloadLink');
                    const url = URL.createObjectURL(fileBlob);
                    downloadLink.href = url;
                    downloadLink.download = packageData.file.name;
                    
                    downloadSection.style.display = 'block';
                    showStatus('receiverStatus', '‚úÖ X√°c minh th√†nh c√¥ng! File c√≥ th·ªÉ t·∫£i v·ªÅ an to√†n.', 'success');
                } else {
                    statusDiv.innerHTML = `
                        <div style="color: #721c24; font-weight: bold; font-size: 1.2rem;">
                            ‚ùå G√ìI TRUY·ªÄN KH√îNG H·ª¢P L·ªÜ
                        </div>
                        <p style="margin-top: 10px; color: #721c24;">
                            <strong>C·∫¢NH B√ÅO:</strong> G√≥i truy·ªÅn c√≥ th·ªÉ ƒë√£ b·ªã thay ƒë·ªïi ho·∫∑c kh√¥ng ƒë√∫ng ng∆∞·ªùi g·ª≠i. 
                            Kh√¥ng n√™n t·∫£i file n√†y!
                        </p>
                        <div style="margin-top: 15px; padding: 10px; background: #f8d7da; border-radius: 5px; color: #721c24;">
                            <strong>‚ö†Ô∏è L√Ω do c√≥ th·ªÉ:</strong><br>
                            ‚Ä¢ Ch·ªØ k√Ω kh√¥ng h·ª£p l·ªá<br>
                            ‚Ä¢ File ƒë√£ b·ªã thay ƒë·ªïi<br>
                            ‚Ä¢ Kh√≥a c√¥ng khai sai<br>
                            ‚Ä¢ G√≥i truy·ªÅn b·ªã h·ªèng
                        </div>
                    `;
                    downloadSection.style.display = 'none';
                    showStatus('receiverStatus', '‚ùå G√≥i truy·ªÅn kh√¥ng h·ª£p l·ªá! Kh√¥ng an to√†n ƒë·ªÉ t·∫£i.', 'error');
                }

            } catch (error) {
                showStatus('receiverStatus', '‚ùå L·ªói khi x√°c minh g√≥i truy·ªÅn: ' + error.message, 'error');
                document.getElementById('verificationResult').style.display = 'none';
            }
        }

        // X√°c minh ch·ªØ k√Ω
        async function verifySignature() {
            const publicKeyInput = document.getElementById('publicKeyInput').value.trim();
            const signatureInput = document.getElementById('signatureInput').value.trim();

            if (!receivedFile || !publicKeyInput || !signatureInput) {
                showStatus('receiverStatus', '‚ùå Vui l√≤ng cung c·∫•p ƒë·∫ßy ƒë·ªß file, kh√≥a c√¥ng khai v√† ch·ªØ k√Ω!', 'error');
                return;
            }

            try {
                showStatus('receiverStatus', 'ƒêang x√°c minh ch·ªØ k√Ω...', 'success');

                // Import kh√≥a c√¥ng khai
                const publicKeyBuffer = base64ToArrayBuffer(publicKeyInput);
                const publicKey = await window.crypto.subtle.importKey(
                    "spki",
                    publicKeyBuffer,
                    {
                        name: "RSA-PSS",
                        hash: "SHA-256",
                    },
                    false,
                    ["verify"]
                );

                // ƒê·ªçc file v√† t·∫°o hash
                const fileBuffer = await receivedFile.arrayBuffer();
                const hashBuffer = await window.crypto.subtle.digest('SHA-256', fileBuffer);

                // Chuy·ªÉn ƒë·ªïi ch·ªØ k√Ω t·ª´ base64
                const signatureBuffer = base64ToArrayBuffer(signatureInput);

                // X√°c minh ch·ªØ k√Ω
                const isValid = await window.crypto.subtle.verify(
                    {
                        name: "RSA-PSS",
                        saltLength: 32,
                    },
                    publicKey,
                    signatureBuffer,
                    hashBuffer
                );

                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                const resultDiv = document.getElementById('verificationResult');
                const statusDiv = document.getElementById('verificationStatus');
                const downloadSection = document.getElementById('downloadSection');

                resultDiv.style.display = 'block';

                if (isValid) {
                    statusDiv.innerHTML = `
                        <div style="color: #155724; font-weight: bold; font-size: 1.2rem;">
                            ‚úÖ CH·ªÆ K√ù H·ª¢P L·ªÜ
                        </div>
                        <p style="margin-top: 10px;">File ƒë√£ ƒë∆∞·ª£c x√°c minh th√†nh c√¥ng. B·∫°n c√≥ th·ªÉ t·∫£i xu·ªëng m·ªôt c√°ch an to√†n.</p>
                    `;
                    
                    // T·∫°o link download
                    const downloadLink = document.getElementById('downloadLink');
                    const url = URL.createObjectURL(receivedFile);
                    downloadLink.href = url;
                    downloadLink.download = receivedFile.name;
                    
                    downloadSection.style.display = 'block';
                    showStatus('receiverStatus', '‚úÖ X√°c minh th√†nh c√¥ng! File c√≥ th·ªÉ t·∫£i v·ªÅ an to√†n.', 'success');
                } else {
                    statusDiv.innerHTML = `
                        <div style="color: #721c24; font-weight: bold; font-size: 1.2rem;">
                            ‚ùå CH·ªÆ K√ù KH√îNG H·ª¢P L·ªÜ
                        </div>
                        <p style="margin-top: 10px; color: #721c24;">
                            <strong>C·∫¢NH B√ÅO:</strong> File c√≥ th·ªÉ ƒë√£ b·ªã thay ƒë·ªïi ho·∫∑c ch·ªØ k√Ω kh√¥ng ƒë√∫ng. 
                            Kh√¥ng n√™n t·∫£i file n√†y!
                        </p>
                    `;
                    downloadSection.style.display = 'none';
                    showStatus('receiverStatus', '‚ùå Ch·ªØ k√Ω kh√¥ng h·ª£p l·ªá! File c√≥ th·ªÉ ƒë√£ b·ªã thay ƒë·ªïi.', 'error');
                }

            } catch (error) {
                showStatus('receiverStatus', '‚ùå L·ªói khi x√°c minh: ' + error.message, 'error');
                document.getElementById('verificationResult').style.display = 'none';
            }
        }

        // Kh·ªüi t·∫°o
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('signerStatus', 'üëã Ch√†o m·ª´ng! H√£y b·∫Øt ƒë·∫ßu b·∫±ng c√°ch ch·ªçn file v√† t·∫°o kh√≥a RSA.', 'success');
        });
    </script>
</body>
</html>